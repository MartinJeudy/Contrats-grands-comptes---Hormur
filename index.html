<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hormur Sales ‚Äî Prospection Grands Comptes</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300..700;1,9..40,300..700&family=Fraunces:ital,opsz,wght@0,9..144,300..900;1,9..144,300..900&display=swap"
    rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase SDK - utilisation de jsDelivr (plus fiable) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script>
    // FIX 1: Tailwind config doit utiliser "tailwind.config" et non "tailwindcss.config"
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { 'display': ['Fraunces', 'serif'], 'sans': ['DM Sans', 'system-ui', 'sans-serif'] },
          colors: {
            'hormur': {
              'cream': '#FDF8F3', 'sand': '#E8DDD4', 'terracotta': '#C4704B', 'rust': '#A85632',
              'deep': '#2D2926', 'forest': '#2C4A3E', 'sage': '#8B9D83', 'gold': '#D4A853'
            }
          }
        }
      }
    }
  </script>
  <style>
    * {
      -webkit-font-smoothing: antialiased;
    }

    body {
      background: linear-gradient(135deg, #FDF8F3 0%, #E8DDD4 100%);
      min-height: 100vh;
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.75);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.8);
    }

    .status-badge {
      font-size: 0.65rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      font-weight: 600;
    }

    .btn-primary {
      background: linear-gradient(135deg, #C4704B 0%, #A85632 100%);
      transition: all 0.3s ease;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 40px rgba(196, 112, 75, 0.3);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: linear-gradient(135deg, #2C4A3E 0%, #1a2d26 100%);
    }

    .btn-ghost {
      background: transparent;
      border: 2px solid rgba(45, 41, 38, 0.2);
    }

    .btn-ghost:hover {
      border-color: #C4704B;
      background: rgba(196, 112, 75, 0.1);
    }

    .input-field {
      background: rgba(255, 255, 255, 0.8);
      border: 1px solid rgba(45, 41, 38, 0.1);
      transition: all 0.3s ease;
    }

    .input-field:focus {
      border-color: #C4704B;
      box-shadow: 0 0 0 3px rgba(196, 112, 75, 0.1);
      outline: none;
    }

    .lead-card {
      transition: all 0.3s ease;
    }

    .lead-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 60px rgba(45, 41, 38, 0.15);
    }

    .lead-card.dragging {
      opacity: 0.5;
      transform: rotate(2deg) scale(1.02);
      cursor: grabbing;
    }

    .lead-card[draggable="true"] {
      cursor: grab;
    }

    .pipeline-column.drag-over {
      background: rgba(196, 112, 75, 0.08);
      border: 2px dashed rgba(196, 112, 75, 0.4);
      border-radius: 1rem;
    }

    .nav-item.active::after {
      content: '';
      position: absolute;
      bottom: -4px;
      left: 50%;
      transform: translateX(-50%);
      width: 24px;
      height: 3px;
      background: #C4704B;
      border-radius: 2px;
    }

    .message-bubble {
      max-width: 80%;
      word-wrap: break-word;
    }

    .message-bubble.incoming {
      background: #f5f5f5;
      border-radius: 18px 18px 18px 4px;
    }

    .message-bubble.outgoing {
      background: linear-gradient(135deg, #C4704B 0%, #A85632 100%);
      color: white;
      border-radius: 18px 18px 4px 18px;
    }

    .toast {
      animation: slideUp 0.4s ease-out;
    }

    @keyframes slideUp {
      0% {
        opacity: 0;
        transform: translate(-50%, 20px);
      }

      100% {
        opacity: 1;
        transform: translate(-50%, 0);
      }
    }

    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(232, 221, 212, 0.5);
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(196, 112, 75, 0.4);
      border-radius: 3px;
    }

    @media (max-width: 768px) {
      .mobile-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 50;
      }
    }

    .template-card:hover {
      background: rgba(196, 112, 75, 0.1);
      transform: translateX(4px);
    }
  </style>
</head>

<body class="font-sans text-hormur-deep">
  <div id="root"></div>

  <!-- Configuration - Modifiez config.js avec vos credentials -->
  <script src="config.js"></script>

  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useCallback, createContext, useContext, useMemo, useRef } = React;

    // ============================================
    // CONFIGURATION
    // ============================================
    const CONFIG = {
      SUPABASE_URL: window.SUPABASE_URL || 'https://VOTRE_PROJET.supabase.co',
      SUPABASE_ANON_KEY: window.SUPABASE_ANON_KEY || 'VOTRE_ANON_KEY',
      N8N_WEBHOOK_SEND: window.N8N_WEBHOOK_SEND || 'https://n8n.srv971805.hstgr.cloud/webhook/hormur-send-message',
      N8N_WEBHOOK_IMPORT: window.N8N_WEBHOOK_IMPORT || 'https://n8n.srv971805.hstgr.cloud/webhook/61df4721-2044-4fa9-b1b7-9b45414c957e',
      UNIPILE_ACCOUNT_ID: 'K3CniNpFRS2GBzOjMzL5sg',
    };

    // FIX 2: Initialisation Supabase robuste
    // Le SDK jsDelivr UMD expose window.supabase.createClient
    const initSupabase = () => {
      // V√©rifier que les credentials sont configur√©s
      if (!CONFIG.SUPABASE_URL || CONFIG.SUPABASE_URL.includes('VOTRE_PROJET') ||
        !CONFIG.SUPABASE_ANON_KEY || CONFIG.SUPABASE_ANON_KEY.includes('VOTRE_ANON')) {
        console.error('Supabase: Configurez config.js avec vos vraies valeurs !');
        return null;
      }

      // Le SDK UMD de jsDelivr expose window.supabase avec createClient dedans
      try {
        if (window.supabase && typeof window.supabase.createClient === 'function') {
          return window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
        }
        // Fallback : certaines versions exposent directement createClient
        if (typeof window.createClient === 'function') {
          return window.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
        }
        console.error('Supabase SDK introuvable. V√©rifiez votre connexion internet.');
        return null;
      } catch (e) {
        console.error('Erreur cr√©ation client Supabase:', e);
        return null;
      }
    };

    // FIX 3: supabase initialis√© une seule fois, au bon moment
    const supabase = initSupabase();

    // ============================================
    // CONSTANTES
    // ============================================
    const STATUSES = {
      TO_CONTACT: { label: '√Ä contacter', color: 'bg-gray-400', textColor: 'text-white' },
      INVITE_SENT: { label: 'Invitation envoy√©e', color: 'bg-blue-400', textColor: 'text-white' },
      CONNECTED: { label: 'Connect√©', color: 'bg-cyan-500', textColor: 'text-white' },
      MSG_1_SENT: { label: 'Message envoy√©', color: 'bg-indigo-400', textColor: 'text-white' },
      RELANCE_1_SENT: { label: 'Relance 1', color: 'bg-violet-400', textColor: 'text-white' },
      RELANCE_2_SENT: { label: 'Relance 2', color: 'bg-purple-400', textColor: 'text-white' },
      REPLIED: { label: 'üî• R√©ponse', color: 'bg-amber-500', textColor: 'text-white' },
      ASSIGNED: { label: 'Pris en charge', color: 'bg-orange-500', textColor: 'text-white' },
      EN_NEGO: { label: 'En n√©gociation', color: 'bg-emerald-500', textColor: 'text-white' },
      RDV_PRIS: { label: 'RDV planifi√©', color: 'bg-teal-600', textColor: 'text-white' },
      CONTRAT_EN_COURS: { label: 'Contrat en cours', color: 'bg-green-500', textColor: 'text-white' },
      SIGNE: { label: 'üéâ Sign√©', color: 'bg-green-600', textColor: 'text-white' },
      PERDU: { label: 'Perdu', color: 'bg-red-500', textColor: 'text-white' },
    };

    const PIPELINE_STAGES = ['REPLIED', 'ASSIGNED', 'EN_NEGO', 'RDV_PRIS', 'CONTRAT_EN_COURS', 'SIGNE', 'PERDU'];

    const DEFAULT_TEMPLATES = [
      { id: 1, title: "Proposition de RDV", category: "rdv", content: "Bonjour {first_name},\n\nMerci pour votre retour ! Je serais ravi d'√©changer plus en d√©tail sur vos besoins.\n\nVoici mon lien pour r√©server un cr√©neau : {calendly_link}\n\n√Ä tr√®s vite,\nMartin Jeudy\nCEO Hormur" },
      { id: 2, title: "Pas le budget", category: "relance", content: "Bonjour {first_name},\n\nJe comprends tout √† fait. Je me permets de noter votre int√©r√™t et reviendrai vers vous dans quelques mois.\n\nBien cordialement,\nMartin Jeudy" },
      { id: 3, title: "Demande d'infos", category: "info", content: "Bonjour {first_name},\n\nAvec plaisir ! Hormur permet aux entreprises comme {company} d'offrir des exp√©riences artistiques uniques : concerts intimistes, ateliers cr√©atifs, performances...\n\nJe vous propose un √©change de 15 minutes : {calendly_link}\n\nMartin Jeudy" },
      { id: 4, title: "Pas int√©ress√©", category: "cloture", content: "Bonjour {first_name},\n\nJe vous remercie pour votre retour. Je reste disponible si vos besoins √©voluent.\n\nBonne continuation,\nMartin Jeudy" },
      { id: 5, title: "Relance apr√®s RDV", category: "suivi", content: "Bonjour {first_name},\n\nSuite √† notre √©change, je voulais m'assurer que vous aviez bien re√ßu les √©l√©ments √©voqu√©s.\n\nAvez-vous pu en discuter en interne ?\n\nBien cordialement,\nMartin Jeudy" },
      { id: 6, title: "Envoi proposition", category: "contrat", content: "Bonjour {first_name},\n\nComme convenu, vous trouverez ci-joint notre proposition pour {company}.\n\nJe me tiens √† votre disposition pour en discuter.\n\nBien cordialement,\nMartin Jeudy" },
    ];

    // ============================================
    // CONTEXT & HOOKS
    // ============================================
    const AppContext = createContext(null);
    const useApp = () => useContext(AppContext);

    // ============================================
    // UTILITY
    // ============================================
    const formatRelativeTime = (d) => {
      if (!d) return '';
      const diff = Math.floor((new Date() - new Date(d)) / 60000);
      if (diff < 1) return "√Ä l'instant";
      if (diff < 60) return `Il y a ${diff} min`;
      if (diff < 1440) return `Il y a ${Math.floor(diff / 60)}h`;
      return `Il y a ${Math.floor(diff / 1440)}j`;
    };

    const formatDateTime = (d) => d ? new Date(d).toLocaleString('fr-FR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' }) : '';

    // ============================================
    // ICON COMPONENT
    // ============================================
    const Icon = ({ name, size = 20, className = '' }) => {
      const ref = useRef(null);
      useEffect(() => {
        if (ref.current && lucide[name]) {
          ref.current.innerHTML = '';
          const svg = lucide.createElement(lucide[name]);
          svg.setAttribute('width', size);
          svg.setAttribute('height', size);
          className.split(' ').filter(Boolean).forEach(c => svg.classList.add(c));
          ref.current.appendChild(svg);
        }
      }, [name, size, className]);
      return <span ref={ref} className="inline-flex items-center justify-center" />;
    };

    // ============================================
    // UI COMPONENTS
    // ============================================
    const Toast = ({ message, type = 'success', onClose }) => {
      useEffect(() => { const t = setTimeout(onClose, 4000); return () => clearTimeout(t); }, [onClose]);
      const bg = type === 'success' ? 'bg-hormur-forest' : type === 'error' ? 'bg-red-500' : 'bg-hormur-terracotta';
      return (
        <div className={`toast fixed bottom-24 md:bottom-8 left-1/2 -translate-x-1/2 ${bg} text-white px-6 py-3 rounded-full shadow-2xl z-[100] flex items-center gap-3`}>
          <Icon name={type === 'success' ? 'CheckCircle' : type === 'error' ? 'XCircle' : 'Info'} size={18} />
          <span className="font-medium text-sm">{message}</span>
        </div>
      );
    };

    const Modal = ({ isOpen, onClose, title, children, size = 'md' }) => {
      if (!isOpen) return null;
      const sizes = { sm: 'max-w-md', md: 'max-w-lg', lg: 'max-w-2xl', xl: 'max-w-4xl' };
      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
          <div className="absolute inset-0 bg-hormur-deep/60 backdrop-blur-sm" onClick={onClose} />
          <div className={`glass-card relative w-full ${sizes[size]} rounded-2xl shadow-2xl max-h-[90vh] overflow-hidden flex flex-col bg-white/95`}>
            <div className="flex items-center justify-between p-5 border-b border-hormur-sand/50">
              <h2 className="font-display text-xl font-semibold">{title}</h2>
              <button onClick={onClose} className="p-2 hover:bg-hormur-sand/50 rounded-full"><Icon name="X" size={20} /></button>
            </div>
            <div className="p-5 overflow-y-auto flex-1">{children}</div>
          </div>
        </div>
      );
    };

    const StatusBadge = ({ status }) => {
      const c = STATUSES[status] || { label: status, color: 'bg-gray-400', textColor: 'text-white' };
      return <span className={`status-badge ${c.color} ${c.textColor} px-2.5 py-1 rounded-full`}>{c.label}</span>;
    };

    const Spinner = ({ size = 'md' }) => {
      const s = { sm: 'w-4 h-4', md: 'w-8 h-8', lg: 'w-12 h-12' };
      return <div className={`${s[size]} border-2 border-hormur-sand border-t-hormur-terracotta rounded-full animate-spin`} />;
    };

    const EmptyState = ({ icon, title, description }) => (
      <div className="text-center py-12 text-hormur-deep/40">
        <Icon name={icon} size={48} className="mx-auto mb-4 opacity-40" />
        <h3 className="font-medium text-lg mb-2">{title}</h3>
        {description && <p className="text-sm">{description}</p>}
      </div>
    );

    // ============================================
    // LOGIN PAGE
    // ============================================
    const LoginPage = ({ onLogin }) => {
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);

      const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        setLoading(true);

        if (!supabase) {
          setError('Erreur de configuration. V√©rifiez config.js et rechargez la page.');
          setLoading(false);
          return;
        }

        try {
          const { data, error: dbErr } = await supabase.from('users').select('*').eq('email', email.toLowerCase().trim()).single();
          if (dbErr || !data) { setError('Compte non trouv√©'); setLoading(false); return; }
          if (data.password_hash !== password) { setError('Mot de passe incorrect'); setLoading(false); return; }
          if (!data.active) { setError('Compte d√©sactiv√©'); setLoading(false); return; }
          localStorage.setItem('hormur_user', JSON.stringify(data));
          onLogin(data);
        } catch (err) { setError('Erreur de connexion. V√©rifiez votre configuration Supabase.'); console.error(err); }
        setLoading(false);
      };

      return (
        <div className="min-h-screen flex items-center justify-center p-4">
          <div className="glass-card rounded-3xl p-8 md:p-12 w-full max-w-md">
            <div className="text-center mb-8">
              <div className="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-hormur-terracotta to-hormur-rust rounded-2xl mb-4 shadow-lg">
                <Icon name="Sparkles" size={32} className="text-white" />
              </div>
              <h1 className="font-display text-3xl font-bold mb-2">Hormur Sales</h1>
              <p className="text-hormur-deep/60">Prospection Grands Comptes</p>
            </div>
            <form onSubmit={handleSubmit} className="space-y-5">
              {error && <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-xl text-sm flex items-center gap-2"><Icon name="AlertCircle" size={16} />{error}</div>}
              <div>
                <label className="block text-sm font-medium text-hormur-deep/70 mb-2">Email</label>
                <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="input-field w-full px-4 py-3 rounded-xl" placeholder="votre@email.com" required />
              </div>
              <div>
                <label className="block text-sm font-medium text-hormur-deep/70 mb-2">Mot de passe</label>
                <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="input-field w-full px-4 py-3 rounded-xl" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
              </div>
              <button type="submit" disabled={loading} className="btn-primary w-full py-4 rounded-xl text-white font-semibold">
                {loading ? <span className="flex items-center justify-center gap-2"><Spinner size="sm" />Connexion...</span> : 'Se connecter'}
              </button>
            </form>
          </div>
        </div>
      );
    };

    // ============================================
    // NAVIGATION
    // ============================================
    const Navigation = ({ currentView, setCurrentView, user, onLogout, unreadCount = 0 }) => {
      const navItems = [
        { id: 'dashboard', icon: 'LayoutDashboard', label: 'Dashboard' },
        { id: 'pipeline', icon: 'Kanban', label: 'Pipeline', badge: unreadCount },
        { id: 'prospects', icon: 'Users', label: 'Prospects' },
        { id: 'leaderboard', icon: 'Trophy', label: 'Classement' },
      ];
      if (user.role === 'admin') navItems.push({ id: 'admin', icon: 'Settings', label: 'Admin' });

      return (
        <>
          {/* Desktop Nav */}
          <nav className="hidden md:block glass-card fixed top-4 left-4 right-4 z-40 rounded-2xl shadow-xl">
            <div className="flex items-center justify-between px-6 py-4">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 bg-gradient-to-br from-hormur-terracotta to-hormur-rust rounded-xl flex items-center justify-center shadow-md">
                  <Icon name="Sparkles" size={20} className="text-white" />
                </div>
                <span className="font-display text-xl font-bold">Hormur Sales</span>
              </div>
              <div className="flex items-center gap-1">
                {navItems.map(item => (
                  <button key={item.id} onClick={() => setCurrentView(item.id)} className={`nav-item relative flex items-center gap-2 px-4 py-2 rounded-xl transition-colors ${currentView === item.id ? 'text-hormur-terracotta font-semibold' : 'text-hormur-deep/60 hover:text-hormur-deep hover:bg-hormur-sand/30'}`}>
                    <Icon name={item.icon} size={18} /><span>{item.label}</span>
                    {item.badge > 0 && <span className="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-[10px] font-bold rounded-full flex items-center justify-center">{item.badge > 9 ? '9+' : item.badge}</span>}
                  </button>
                ))}
              </div>
              <div className="flex items-center gap-4">
                <button onClick={() => setCurrentView('profile')} className="flex items-center gap-3 hover:bg-hormur-sand/30 px-3 py-2 rounded-xl transition-colors">
                  <div className="text-right">
                    <p className="text-sm font-medium">{user.name}</p>
                    <p className="text-xs text-hormur-deep/50">{user.role === 'admin' ? 'Admin' : 'Commercial'}</p>
                  </div>
                  <div className="w-9 h-9 bg-hormur-sand rounded-full flex items-center justify-center">
                    <span className="text-sm font-semibold">{user.name?.split(' ').map(n => n[0]).join('').slice(0, 2)}</span>
                  </div>
                </button>
                <button onClick={onLogout} className="p-2 hover:bg-hormur-sand/50 rounded-xl" title="D√©connexion"><Icon name="LogOut" size={20} className="text-hormur-deep/60" /></button>
              </div>
            </div>
          </nav>

          {/* Mobile Nav */}
          <nav className="md:hidden mobile-nav glass-card shadow-2xl border-t border-hormur-sand/50">
            <div className="flex items-center justify-around py-2 px-2">
              {navItems.slice(0, 4).map(item => (
                <button key={item.id} onClick={() => setCurrentView(item.id)} className={`relative flex flex-col items-center gap-1 px-3 py-2 rounded-xl ${currentView === item.id ? 'text-hormur-terracotta' : 'text-hormur-deep/50'}`}>
                  <Icon name={item.icon} size={22} /><span className="text-[10px] font-medium">{item.label}</span>
                  {item.badge > 0 && <span className="absolute top-0 right-1 w-4 h-4 bg-red-500 text-white text-[9px] font-bold rounded-full flex items-center justify-center">{item.badge}</span>}
                </button>
              ))}
              <button onClick={onLogout} className="flex flex-col items-center gap-1 px-3 py-2 text-hormur-deep/50">
                <Icon name="LogOut" size={22} /><span className="text-[10px] font-medium">Sortir</span>
              </button>
            </div>
          </nav>

          {/* Mobile Header */}
          <header className="md:hidden glass-card fixed top-0 left-0 right-0 z-40 px-4 py-3 flex items-center justify-between shadow-md">
            <div className="flex items-center gap-2">
              <div className="w-8 h-8 bg-gradient-to-br from-hormur-terracotta to-hormur-rust rounded-lg flex items-center justify-center">
                <Icon name="Sparkles" size={16} className="text-white" />
              </div>
              <span className="font-display text-lg font-bold">Hormur Sales</span>
            </div>
            <button onClick={() => setCurrentView('profile')} className="w-8 h-8 bg-hormur-sand rounded-full flex items-center justify-center">
              <span className="text-xs font-semibold">{user.name?.split(' ').map(n => n[0]).join('').slice(0, 2)}</span>
            </button>
          </header>
        </>
      );
    };

    // ============================================
    // CONVERSATION VIEW (MESSAGERIE)
    // ============================================
    const ConversationView = ({ prospect, onBack }) => {
      const { user, templates, showToast, updateProspectStatus, refreshProspects } = useApp();
      const [messages, setMessages] = useState([]);
      const [newMessage, setNewMessage] = useState('');
      const [loading, setLoading] = useState(true);
      const [sending, setSending] = useState(false);
      const [showTemplates, setShowTemplates] = useState(false);
      const messagesEndRef = useRef(null);

      useEffect(() => {
        loadMessages();
        const sub = supabase.channel(`msg-${prospect.id}`)
          .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `prospect_id=eq.${prospect.id}` },
            (payload) => setMessages(prev => prev.find(m => m.id === payload.new.id) ? prev : [...prev, payload.new]))
          .subscribe();
        return () => sub.unsubscribe();
      }, [prospect.id]);

      useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages]);

      const loadMessages = async () => {
        const { data } = await supabase.from('messages').select('*').eq('prospect_id', prospect.id).order('sent_at', { ascending: true });
        setMessages(data || []);
        setLoading(false);
      };

      const applyTemplate = (t) => {
        setNewMessage(t.content
          .replace(/{first_name}/g, prospect.first_name || 'Bonjour')
          .replace(/{company}/g, prospect.company || '')
          .replace(/{calendly_link}/g, user.calendly_link || 'https://calendly.com/votre-lien'));
        setShowTemplates(false);
      };

      const sendMessage = async () => {
        if (!newMessage.trim() || sending) return;
        setSending(true);
        try {
          const { data: msgData, error: insertErr } = await supabase.from('messages').insert({
            prospect_id: prospect.id, content: newMessage.trim(), direction: 'outgoing',
            sender_id: user.id, sender_name: user.name, status: 'pending', sent_at: new Date().toISOString()
          }).select().single();
          if (insertErr) throw insertErr;

          const res = await fetch(CONFIG.N8N_WEBHOOK_SEND, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: 'send_message', prospect_id: prospect.id, chat_id: prospect.chat_id,
              provider_id: prospect.provider_id_linkedin, message: newMessage.trim(),
              account_id: CONFIG.UNIPILE_ACCOUNT_ID, message_db_id: msgData.id, sender_name: user.name
            })
          });
          if (!res.ok) throw new Error('Erreur n8n');

          await supabase.from('messages').update({ status: 'sent' }).eq('id', msgData.id);
          await supabase.from('activity_log').insert({ user_id: user.id, prospect_id: prospect.id, action: 'message_sent' });

          setNewMessage('');
          showToast('Message envoy√© !');
        } catch (err) {
          console.error('Erreur envoi:', err);
          showToast('Erreur lors de l\'envoi', 'error');
        }
        setSending(false);
      };

      return (
        <div className="flex flex-col h-[calc(100vh-8rem)]">
          <div className="glass-card rounded-2xl p-4 mb-4 flex items-center justify-between">
            <div className="flex items-center gap-4">
              <button onClick={onBack} className="p-2 hover:bg-hormur-sand/50 rounded-xl"><Icon name="ArrowLeft" size={20} /></button>
              <div>
                <h2 className="font-semibold text-lg">{prospect.first_name} {prospect.last_name}</h2>
                <p className="text-sm text-hormur-deep/60">{prospect.company} {prospect.post && `‚Ä¢ ${prospect.post}`}</p>
              </div>
            </div>
            <div className="flex items-center gap-3">
              <StatusBadge status={prospect.status} />
              <select value={prospect.status} onChange={(e) => { updateProspectStatus(prospect.id, e.target.value); refreshProspects(); }} className="input-field px-3 py-1.5 rounded-lg text-sm">
                {PIPELINE_STAGES.map(s => <option key={s} value={s}>{STATUSES[s].label}</option>)}
              </select>
            </div>
          </div>

          <div className="glass-card rounded-2xl flex-1 flex flex-col overflow-hidden">
            <div className="flex-1 overflow-y-auto p-4 space-y-3">
              {loading ? <div className="flex justify-center py-8"><Spinner /></div> : messages.length === 0 ? (
                <EmptyState icon="MessageSquare" title="Aucun message" description="Les messages du prospect appara√Ætront ici" />
              ) : messages.map((msg, idx) => (
                <div key={msg.id || idx} className={`flex ${msg.direction === 'outgoing' ? 'justify-end' : 'justify-start'}`}>
                  <div className={`message-bubble ${msg.direction} p-3 shadow-sm`}>
                    <p className="text-sm whitespace-pre-wrap leading-relaxed">{msg.content}</p>
                    <p className={`text-xs mt-2 ${msg.direction === 'outgoing' ? 'text-white/70' : 'text-hormur-deep/50'}`}>
                      {formatDateTime(msg.sent_at)}
                      {msg.direction === 'outgoing' && msg.sender_name && ` ‚Ä¢ ${msg.sender_name}`}
                      {msg.status === 'pending' && ' ‚Ä¢ ‚è≥'}
                      {msg.status === 'failed' && ' ‚Ä¢ ‚ùå'}
                    </p>
                  </div>
                </div>
              ))}
              <div ref={messagesEndRef} />
            </div>

            <div className="border-t border-hormur-sand/50 p-4">
              {showTemplates && (
                <div className="mb-3 max-h-48 overflow-y-auto bg-hormur-cream/50 rounded-xl p-3">
                  <p className="text-xs font-semibold text-hormur-deep/60 mb-2 uppercase">Templates</p>
                  <div className="grid gap-2">
                    {templates.map(t => (
                      <button key={t.id} onClick={() => applyTemplate(t)} className="template-card text-left p-3 bg-white/60 rounded-lg transition-all">
                        <p className="font-medium text-sm">{t.title}</p>
                        <p className="text-xs text-hormur-deep/50 truncate">{t.content.substring(0, 50)}...</p>
                      </button>
                    ))}
                  </div>
                </div>
              )}
              <div className="flex gap-2">
                <button onClick={() => setShowTemplates(!showTemplates)} className={`p-3 rounded-xl transition-colors ${showTemplates ? 'bg-hormur-terracotta text-white' : 'bg-hormur-cream/50 hover:bg-hormur-sand/50'}`}><Icon name="FileText" size={20} /></button>
                <textarea value={newMessage} onChange={(e) => setNewMessage(e.target.value)} onKeyDown={(e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }} placeholder="√âcrire un message... (Entr√©e pour envoyer)" className="input-field flex-1 px-4 py-3 rounded-xl resize-none" rows={2} />
                <button onClick={sendMessage} disabled={!newMessage.trim() || sending} className="btn-primary px-4 rounded-xl text-white">
                  {sending ? <Spinner size="sm" /> : <Icon name="Send" size={20} />}
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // ============================================
    // PIPELINE VIEW (Drag & Drop)
    // ============================================
    const PipelineView = () => {
      const { prospects, user, claimLead, updateProspectStatus } = useApp();
      const [selectedProspect, setSelectedProspect] = useState(null);
      const [draggedItem, setDraggedItem] = useState(null);

      const pipelineData = useMemo(() => {
        const stages = {};
        PIPELINE_STAGES.forEach(status => {
          stages[status] = prospects.filter(p => {
            if (status === 'REPLIED') return p.status === 'REPLIED' && !p.assigned_to;
            return p.status === status && p.assigned_to === user.id;
          });
        });
        return stages;
      }, [prospects, user.id]);

      const handleDragStart = (e, p) => { setDraggedItem(p); e.currentTarget.classList.add('dragging'); };
      const handleDragEnd = (e) => { e.currentTarget.classList.remove('dragging'); setDraggedItem(null); document.querySelectorAll('.pipeline-column').forEach(c => c.classList.remove('drag-over')); };
      const handleDragOver = (e) => { e.preventDefault(); e.currentTarget.classList.add('drag-over'); };
      const handleDragLeave = (e) => { e.currentTarget.classList.remove('drag-over'); };
      const handleDrop = async (e, newStatus) => {
        e.preventDefault();
        e.currentTarget.classList.remove('drag-over');
        if (!draggedItem || draggedItem.status === newStatus) return;
        if (draggedItem.status === 'REPLIED' && !draggedItem.assigned_to) {
          await claimLead(draggedItem.id);
          if (newStatus !== 'REPLIED' && newStatus !== 'ASSIGNED') await updateProspectStatus(draggedItem.id, newStatus);
        } else {
          await updateProspectStatus(draggedItem.id, newStatus);
        }
      };

      if (selectedProspect) return <ConversationView prospect={selectedProspect} onBack={() => setSelectedProspect(null)} />;

      return (
        <div>
          <div className="flex items-center justify-between mb-6">
            <h1 className="font-display text-2xl font-bold">Mon Pipeline</h1>
            <div className="text-sm text-hormur-deep/60">{Object.values(pipelineData).flat().length} prospects actifs</div>
          </div>

          <div className="flex gap-4 overflow-x-auto pb-4 -mx-4 px-4 md:mx-0 md:px-0">
            {PIPELINE_STAGES.map(status => {
              const items = pipelineData[status] || [];
              const cfg = STATUSES[status];
              return (
                <div key={status} className="pipeline-column min-w-[300px] flex-shrink-0" onDragOver={handleDragOver} onDragLeave={handleDragLeave} onDrop={(e) => handleDrop(e, status)}>
                  <div className="glass-card rounded-2xl p-4 min-h-[450px]">
                    <div className="flex items-center gap-2 mb-4 pb-3 border-b border-hormur-sand/50">
                      <span className={`w-3 h-3 rounded-full ${cfg.color}`}></span>
                      <span className="font-semibold text-hormur-deep">{cfg.label}</span>
                      <span className="ml-auto text-sm text-hormur-deep/50 bg-hormur-sand/30 px-2 py-0.5 rounded-full">{items.length}</span>
                    </div>
                    <div className="space-y-3">
                      {items.map(lead => {
                        const canDrag = lead.assigned_to === user.id || (status === 'REPLIED' && !lead.assigned_to);
                        return (
                          <div key={lead.id} draggable={canDrag} onDragStart={canDrag ? (e) => handleDragStart(e, lead) : undefined} onDragEnd={canDrag ? handleDragEnd : undefined} onClick={() => setSelectedProspect(lead)} className="lead-card bg-white/80 rounded-xl p-4 cursor-pointer">
                            <div className="flex items-start justify-between mb-2">
                              <div className="flex-1 min-w-0">
                                <p className="font-medium truncate">{lead.first_name} {lead.last_name}</p>
                                <p className="text-sm text-hormur-deep/60 truncate">{lead.company}</p>
                              </div>
                              {lead.message_count > 0 && <span className="flex items-center gap-1 bg-hormur-terracotta/10 text-hormur-terracotta text-xs px-2 py-0.5 rounded-full ml-2"><Icon name="MessageSquare" size={10} />{lead.message_count}</span>}
                            </div>
                            {lead.last_message_content && <p className="text-xs text-hormur-deep/50 truncate mb-2 italic">"{lead.last_message_content.substring(0, 40)}..."</p>}
                            {lead.last_update && <p className="text-xs text-hormur-deep/40">{formatRelativeTime(lead.last_update)}</p>}
                            {status === 'REPLIED' && !lead.assigned_to && (
                              <button onClick={(e) => { e.stopPropagation(); claimLead(lead.id); }} className="w-full mt-3 btn-primary py-2 rounded-lg text-white text-sm font-medium">Prendre ce lead</button>
                            )}
                          </div>
                        );
                      })}
                      {items.length === 0 && <div className="text-center py-8 text-hormur-deep/30"><Icon name="Inbox" size={32} className="mx-auto mb-2 opacity-50" /><p className="text-sm">{status === 'REPLIED' ? 'Aucun nouveau lead' : 'Glissez ici'}</p></div>}
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      );
    };

    // ============================================
    // DASHBOARD VIEW
    // ============================================
    const DashboardView = () => {
      const { prospects, user, claimLead, setCurrentView } = useApp();
      const stats = useMemo(() => {
        const my = prospects.filter(p => p.assigned_to === user.id);
        return {
          newReplies: prospects.filter(p => p.status === 'REPLIED' && !p.assigned_to).length,
          myActive: my.filter(p => ['ASSIGNED', 'EN_NEGO', 'RDV_PRIS', 'CONTRAT_EN_COURS'].includes(p.status)).length,
          myRdv: my.filter(p => p.status === 'RDV_PRIS').length,
          mySigned: my.filter(p => p.status === 'SIGNE').length,
        };
      }, [prospects, user.id]);

      const hotLeads = prospects.filter(p => p.status === 'REPLIED' && !p.assigned_to).slice(0, 5);

      return (
        <div className="space-y-6">
          <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
            {[
              { label: 'Nouvelles r√©ponses', value: stats.newReplies, icon: 'Flame', color: 'text-amber-500', bg: 'bg-amber-500/10' },
              { label: 'Mes n√©gos actives', value: stats.myActive, icon: 'MessageSquare', color: 'text-hormur-terracotta', bg: 'bg-hormur-terracotta/10' },
              { label: 'RDV planifi√©s', value: stats.myRdv, icon: 'Calendar', color: 'text-hormur-forest', bg: 'bg-hormur-forest/10' },
              { label: 'Contrats sign√©s', value: stats.mySigned, icon: 'Trophy', color: 'text-green-600', bg: 'bg-green-500/10' },
            ].map((s, i) => (
              <div key={i} className="glass-card rounded-2xl p-5 hover:-translate-y-1 transition-transform">
                <div className="flex items-center gap-3 mb-3">
                  <div className={`w-10 h-10 ${s.bg} rounded-xl flex items-center justify-center`}><Icon name={s.icon} size={20} className={s.color} /></div>
                  <span className="text-sm text-hormur-deep/60">{s.label}</span>
                </div>
                <p className="text-3xl font-display font-bold">{s.value}</p>
              </div>
            ))}
          </div>

          <div className="grid lg:grid-cols-2 gap-6">
            <div className="glass-card rounded-2xl p-6">
              <div className="flex items-center justify-between mb-5">
                <h2 className="font-display text-xl font-semibold flex items-center gap-2"><Icon name="Flame" size={22} className="text-amber-500" />Leads chauds</h2>
                <button onClick={() => setCurrentView('pipeline')} className="text-sm text-hormur-terracotta font-medium hover:underline">Voir tout ‚Üí</button>
              </div>
              {hotLeads.length === 0 ? <EmptyState icon="Inbox" title="Aucun nouveau lead" /> : (
                <div className="space-y-3">
                  {hotLeads.map(lead => (
                    <div key={lead.id} className="flex items-center justify-between p-4 bg-hormur-cream/50 rounded-xl hover:bg-hormur-sand/30 transition-colors">
                      <div className="flex-1 min-w-0 mr-3">
                        <p className="font-medium truncate">{lead.first_name} {lead.last_name}</p>
                        <p className="text-sm text-hormur-deep/60 truncate">{lead.company}</p>
                      </div>
                      <button onClick={() => claimLead(lead.id)} className="btn-primary px-4 py-2 rounded-lg text-white text-sm font-medium flex items-center gap-2 shrink-0"><Icon name="UserPlus" size={16} />Prendre</button>
                    </div>
                  ))}
                </div>
              )}
            </div>

            <div className="glass-card rounded-2xl p-6">
              <h2 className="font-display text-xl font-semibold mb-5">Actions rapides</h2>
              <div className="grid grid-cols-2 gap-4">
                {[
                  { label: 'Mon pipeline', icon: 'Kanban', color: 'text-hormur-terracotta', view: 'pipeline' },
                  { label: 'Importer CSV', icon: 'Upload', color: 'text-hormur-forest', view: 'prospects' },
                  { label: 'Classement', icon: 'Trophy', color: 'text-amber-500', view: 'leaderboard' },
                  { label: 'Mon profil', icon: 'User', color: 'text-hormur-sage', view: 'profile' },
                ].map((a, i) => (
                  <button key={i} onClick={() => setCurrentView(a.view)} className="p-4 bg-hormur-cream/50 hover:bg-hormur-sand/50 rounded-xl transition-all hover:-translate-y-1 text-left">
                    <Icon name={a.icon} size={24} className={`${a.color} mb-2`} /><p className="font-medium text-sm">{a.label}</p>
                  </button>
                ))}
              </div>
            </div>
          </div>
        </div>
      );
    };

    // ============================================
    // PROSPECTS VIEW (Import CSV)
    // ============================================
    const ProspectsView = () => {
      const { prospects, user, refreshProspects, showToast } = useApp();
      const [search, setSearch] = useState('');
      const [filterStatus, setFilterStatus] = useState('all');
      const [showImport, setShowImport] = useState(false);
      const [importText, setImportText] = useState('');
      const [importing, setImporting] = useState(false);

      const filtered = useMemo(() => prospects.filter(p => {
        const matchSearch = !search || `${p.first_name} ${p.last_name} ${p.company}`.toLowerCase().includes(search.toLowerCase());
        const matchStatus = filterStatus === 'all' || p.status === filterStatus;
        return matchSearch && matchStatus;
      }), [prospects, search, filterStatus]);

      const parseCSV = (text) => {
        const lines = text.trim().split('\n');
        if (lines.length < 2) return [];
        const headers = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/['"]/g, ''));
        const urlIdx = headers.findIndex(h => h.includes('linkedin') || h === 'url');
        const companyIdx = headers.findIndex(h => h.includes('company') || h.includes('entreprise'));
        if (urlIdx === -1 || companyIdx === -1) return [];
        const firstIdx = headers.findIndex(h => h.includes('first') || h.includes('pr√©nom'));
        const lastIdx = headers.findIndex(h => h.includes('last') || h.includes('nom'));
        const postIdx = headers.findIndex(h => h.includes('post') || h.includes('poste'));

        const data = [];
        for (let i = 1; i < lines.length; i++) {
          const cols = lines[i].split(',').map(c => c.trim().replace(/['"]/g, ''));
          if (cols[urlIdx]?.includes('linkedin.com') && cols[companyIdx]) {
            data.push({ linkedin_url: cols[urlIdx], company: cols[companyIdx], first_name: firstIdx >= 0 ? cols[firstIdx] || '' : '', last_name: lastIdx >= 0 ? cols[lastIdx] || '' : '', post: postIdx >= 0 ? cols[postIdx] || '' : '' });
          }
        }
        return data;
      };

      const handleImport = async () => {
        const data = parseCSV(importText);
        if (data.length === 0) { showToast('Aucune donn√©e valide', 'error'); return; }
        setImporting(true);
        try {
          const toInsert = data.map(p => ({
            ...p,
            status: 'TO_CONTACT',
            // On ne veut pas √©craser les dates si le prospect existe d√©j√†
            // created_at sera g√©r√© par default
          }));

          // Utilisation de upsert avec ignoreDuplicates pour ne pas √©craser les prospects existants
          // (notamment leur statut s'ils sont d√©j√† avanc√©s dans le pipeline)
          const { error } = await supabase.from('prospects').upsert(toInsert, {
            onConflict: 'linkedin_url',
            ignoreDuplicates: true
          });

          if (error) throw error;

          // Trigger n8n webhook
          if (CONFIG.N8N_WEBHOOK_IMPORT) {
            fetch(CONFIG.N8N_WEBHOOK_IMPORT, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                action: 'import_contacts',
                count: data.length,
                contacts: data,
                imported_at: new Date().toISOString(),
                imported_by: user.email
              })
            }).catch(err => console.error('Webhook import error:', err));
          }

          showToast(`${data.length} prospects import√©s !`);
          setShowImport(false); setImportText(''); refreshProspects();
        } catch (err) { console.error(err); showToast('Erreur import', 'error'); }
        setImporting(false);
      };

      return (
        <div>
          <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
            <h1 className="font-display text-2xl font-bold">Base de prospects</h1>
            <button onClick={() => setShowImport(true)} className="btn-primary px-5 py-2.5 rounded-xl text-white font-medium flex items-center gap-2"><Icon name="Upload" size={18} />Importer CSV</button>
          </div>

          <div className="glass-card rounded-2xl p-4 mb-6 flex flex-col md:flex-row gap-4">
            <div className="flex-1 relative">
              <Icon name="Search" size={18} className="absolute left-3 top-1/2 -translate-y-1/2 text-hormur-deep/40" />
              <input type="text" value={search} onChange={(e) => setSearch(e.target.value)} placeholder="Rechercher..." className="input-field w-full pl-10 pr-4 py-2.5 rounded-xl" />
            </div>
            <select value={filterStatus} onChange={(e) => setFilterStatus(e.target.value)} className="input-field px-4 py-2.5 rounded-xl">
              <option value="all">Tous les statuts</option>
              {Object.entries(STATUSES).map(([k, v]) => <option key={k} value={k}>{v.label}</option>)}
            </select>
          </div>

          <div className="glass-card rounded-2xl overflow-hidden">
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead className="bg-hormur-sand/30">
                  <tr>
                    <th className="px-4 py-3 text-left text-xs font-semibold text-hormur-deep/70 uppercase">Nom</th>
                    <th className="px-4 py-3 text-left text-xs font-semibold text-hormur-deep/70 uppercase">Entreprise</th>
                    <th className="px-4 py-3 text-left text-xs font-semibold text-hormur-deep/70 uppercase">Statut</th>
                    <th className="px-4 py-3 text-left text-xs font-semibold text-hormur-deep/70 uppercase">Commercial</th>
                    <th className="px-4 py-3 text-left text-xs font-semibold text-hormur-deep/70 uppercase">MAJ</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-hormur-sand/30">
                  {filtered.map(p => (
                    <tr key={p.id} className="hover:bg-hormur-cream/30 transition-colors">
                      <td className="px-4 py-3"><p className="font-medium">{p.first_name} {p.last_name}</p>{p.post && <p className="text-xs text-hormur-deep/50">{p.post}</p>}</td>
                      <td className="px-4 py-3 text-hormur-deep/70">{p.company}</td>
                      <td className="px-4 py-3"><StatusBadge status={p.status} /></td>
                      <td className="px-4 py-3 text-sm text-hormur-deep/60">{p.assignee_name || '-'}</td>
                      <td className="px-4 py-3 text-sm text-hormur-deep/50">{formatRelativeTime(p.last_update)}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
            {filtered.length === 0 && <EmptyState icon="Users" title="Aucun prospect trouv√©" />}
          </div>
          <p className="text-sm text-hormur-deep/50 mt-4 text-center">{filtered.length} prospect{filtered.length > 1 ? 's' : ''}</p>

          <Modal isOpen={showImport} onClose={() => setShowImport(false)} title="Importer des prospects" size="lg">
            <div className="space-y-5">
              <div>
                <p className="text-sm text-hormur-deep/70 mb-2">Format CSV attendu :</p>
                <code className="block bg-hormur-cream/50 p-3 rounded-xl text-xs font-mono">linkedin_url,company,first_name,last_name,post</code>
                <p className="text-xs text-hormur-deep/50 mt-2">Colonnes obligatoires : <strong>linkedin_url</strong>, <strong>company</strong></p>
              </div>
              <div>
                <label className="block text-sm font-medium text-hormur-deep/70 mb-2">Collez vos donn√©es CSV :</label>
                <textarea value={importText} onChange={(e) => setImportText(e.target.value)} className="input-field w-full px-4 py-3 rounded-xl h-40 font-mono text-xs resize-none" placeholder="linkedin_url,company,first_name,last_name,post&#10;https://linkedin.com/in/...,LVMH,Jean,Dupont,DRH" />
              </div>
              {parseCSV(importText).length > 0 && (
                <div className="bg-hormur-cream/50 rounded-xl p-3">
                  <p className="text-sm font-medium mb-2">{parseCSV(importText).length} lignes d√©tect√©es</p>
                  {parseCSV(importText).slice(0, 3).map((p, i) => <p key={i} className="text-xs text-hormur-deep/70">{p.first_name} {p.last_name} ‚Äî {p.company}</p>)}
                </div>
              )}
              <button onClick={handleImport} disabled={parseCSV(importText).length === 0 || importing} className="w-full btn-primary py-3 rounded-xl text-white font-semibold disabled:opacity-50">
                {importing ? <span className="flex items-center justify-center gap-2"><Spinner size="sm" />Import...</span> : `Importer ${parseCSV(importText).length || 0} prospects`}
              </button>
            </div>
          </Modal>
        </div>
      );
    };

    // ============================================
    // LEADERBOARD VIEW
    // ============================================
    const LeaderboardView = () => {
      const { leaderboard } = useApp();
      const medals = ['ü•á', 'ü•à', 'ü•â'];

      return (
        <div>
          <h1 className="font-display text-2xl font-bold mb-6">Classement</h1>

          {leaderboard.length >= 3 && (
            <div className="glass-card rounded-2xl p-6 mb-6">
              <div className="flex items-end justify-center gap-4 h-52">
                {leaderboard.slice(0, 3).map((u, idx) => (
                  <div key={u.id} className={`flex flex-col items-center ${idx === 0 ? 'order-2' : idx === 1 ? 'order-1' : 'order-3'}`}>
                    <span className="text-4xl mb-2">{medals[idx]}</span>
                    <div className={`w-24 md:w-32 ${idx === 0 ? 'h-36 bg-amber-400' : idx === 1 ? 'h-28 bg-gray-300' : 'h-20 bg-orange-300'} rounded-t-xl flex items-center justify-center shadow-lg`}>
                      <span className="text-white font-display text-2xl font-bold">{u.points}</span>
                    </div>
                    <p className="mt-3 text-sm font-medium">{u.name.split(' ')[0]}</p>
                  </div>
                ))}
              </div>
            </div>
          )}

          <div className="glass-card rounded-2xl overflow-hidden">
            <table className="w-full">
              <thead className="bg-hormur-sand/30">
                <tr>
                  <th className="px-4 py-3 text-left text-xs font-semibold uppercase">#</th>
                  <th className="px-4 py-3 text-left text-xs font-semibold uppercase">Commercial</th>
                  <th className="px-4 py-3 text-center text-xs font-semibold uppercase">RDV</th>
                  <th className="px-4 py-3 text-center text-xs font-semibold uppercase">En cours</th>
                  <th className="px-4 py-3 text-center text-xs font-semibold uppercase">Sign√©s</th>
                  <th className="px-4 py-3 text-center text-xs font-semibold uppercase">Points</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-hormur-sand/30">
                {leaderboard.map((u, idx) => (
                  <tr key={u.id} className="hover:bg-hormur-cream/30">
                    <td className="px-4 py-3 font-medium">{idx + 1}</td>
                    <td className="px-4 py-3"><p className="font-medium">{u.name}</p><p className="text-xs text-hormur-deep/50">{u.email}</p></td>
                    <td className="px-4 py-3 text-center">{u.rdv_count || 0}</td>
                    <td className="px-4 py-3 text-center">{u.contract_pending || 0}</td>
                    <td className="px-4 py-3 text-center font-semibold text-green-600">{u.signed_count || 0}</td>
                    <td className="px-4 py-3 text-center"><span className="bg-amber-100 text-amber-800 px-3 py-1 rounded-full font-semibold">{u.points}</span></td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>

          <div className="mt-6 glass-card rounded-2xl p-5">
            <h3 className="font-semibold mb-3">Syst√®me de points</h3>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
              {[{ pts: '+100', label: 'Sign√©', color: 'text-amber-600' }, { pts: '+50', label: 'Contrat en cours', color: 'text-emerald-600' }, { pts: '+25', label: 'RDV pris', color: 'text-teal-600' }, { pts: '+10', label: 'En n√©go', color: 'text-orange-600' }].map((p, i) => (
                <div key={i} className="bg-hormur-cream/50 rounded-xl p-3"><p className={`font-semibold ${p.color}`}>{p.pts}</p><p className="text-hormur-deep/60">{p.label}</p></div>
              ))}
            </div>
          </div>
        </div>
      );
    };

    // ============================================
    // PROFILE VIEW
    // ============================================
    const ProfileView = () => {
      const { user, updateUser, showToast } = useApp();
      const [calendlyLink, setCalendlyLink] = useState(user.calendly_link || '');
      const [phone, setPhone] = useState(user.phone || '');
      const [saving, setSaving] = useState(false);

      const handleSave = async () => {
        setSaving(true);
        try {
          const { error } = await supabase.from('users').update({ calendly_link: calendlyLink, phone }).eq('id', user.id);
          if (error) throw error;
          updateUser({ ...user, calendly_link: calendlyLink, phone });
          showToast('Profil mis √† jour !');
        } catch (err) { console.error(err); showToast('Erreur', 'error'); }
        setSaving(false);
      };

      return (
        <div className="max-w-2xl mx-auto">
          <h1 className="font-display text-2xl font-bold mb-6">Mon profil</h1>

          <div className="glass-card rounded-2xl p-6 space-y-6">
            <div className="flex items-center gap-4 pb-6 border-b border-hormur-sand/50">
              <div className="w-16 h-16 bg-hormur-sand rounded-full flex items-center justify-center">
                <span className="text-xl font-bold">{user.name?.split(' ').map(n => n[0]).join('').slice(0, 2)}</span>
              </div>
              <div>
                <h2 className="text-xl font-semibold">{user.name}</h2>
                <p className="text-hormur-deep/60">{user.email}</p>
                <span className={`text-xs px-2 py-0.5 rounded-full ${user.role === 'admin' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'}`}>{user.role === 'admin' ? 'Administrateur' : 'Commercial'}</span>
              </div>
            </div>

            <div>
              <label className="block text-sm font-medium text-hormur-deep/70 mb-2">Lien Calendly personnel</label>
              <input type="url" value={calendlyLink} onChange={(e) => setCalendlyLink(e.target.value)} className="input-field w-full px-4 py-3 rounded-xl" placeholder="https://calendly.com/votre-nom" />
              <p className="text-xs text-hormur-deep/50 mt-1">Ce lien sera utilis√© dans vos templates de messages</p>
            </div>

            <div>
              <label className="block text-sm font-medium text-hormur-deep/70 mb-2">T√©l√©phone</label>
              <input type="tel" value={phone} onChange={(e) => setPhone(e.target.value)} className="input-field w-full px-4 py-3 rounded-xl" placeholder="+33 6 12 34 56 78" />
            </div>

            <button onClick={handleSave} disabled={saving} className="btn-primary w-full py-3 rounded-xl text-white font-semibold disabled:opacity-50">
              {saving ? <span className="flex items-center justify-center gap-2"><Spinner size="sm" />Enregistrement...</span> : 'Enregistrer'}
            </button>
          </div>
        </div>
      );
    };

    // ============================================
    // ADMIN VIEW
    // ============================================
    const AdminView = () => {
      const { users, refreshUsers, showToast } = useApp();
      const [showAdd, setShowAdd] = useState(false);
      const [newUser, setNewUser] = useState({ name: '', email: '', password: '', calendly_link: '' });
      const [saving, setSaving] = useState(false);

      const commercials = users.filter(u => u.role !== 'admin');

      const handleAdd = async () => {
        if (!newUser.name || !newUser.email || !newUser.password) { showToast('Remplissez tous les champs', 'error'); return; }
        setSaving(true);
        try {
          const { password, ...userWithoutPassword } = newUser;
          const { error } = await supabase.from('users').insert({ ...userWithoutPassword, email: newUser.email.toLowerCase(), password_hash: password, role: 'commercial', active: true });
          if (error) throw error;
          showToast('Commercial ajout√© !');
          setShowAdd(false); setNewUser({ name: '', email: '', password: '', calendly_link: '' }); refreshUsers();
        } catch (err) { console.error(err); showToast('Erreur: ' + (err.message || 'Inconnu'), 'error'); }
        setSaving(false);
      };

      const toggleActive = async (userId, active) => {
        await supabase.from('users').update({ active: !active }).eq('id', userId);
        refreshUsers();
        showToast(!active ? 'Compte activ√©' : 'Compte d√©sactiv√©');
      };

      return (
        <div>
          <h1 className="font-display text-2xl font-bold mb-6">Administration</h1>

          <div className="glass-card rounded-2xl p-6">
            <div className="flex items-center justify-between mb-5">
              <h2 className="font-display text-xl font-semibold">Gestion des commerciaux</h2>
              <button onClick={() => setShowAdd(true)} className="btn-primary px-4 py-2 rounded-xl text-white font-medium flex items-center gap-2"><Icon name="UserPlus" size={18} />Ajouter</button>
            </div>

            <div className="space-y-3">
              {commercials.map(u => (
                <div key={u.id} className="flex items-center justify-between p-4 bg-hormur-cream/50 rounded-xl">
                  <div>
                    <div className="flex items-center gap-3">
                      <p className="font-medium">{u.name}</p>
                      {!u.active && <span className="text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded-full">Inactif</span>}
                    </div>
                    <p className="text-sm text-hormur-deep/60">{u.email}</p>
                    {u.calendly_link && <p className="text-xs text-hormur-terracotta truncate max-w-xs">{u.calendly_link}</p>}
                  </div>
                  <button onClick={() => toggleActive(u.id, u.active)} className={`px-3 py-1.5 rounded-lg text-sm font-medium ${u.active ? 'bg-red-50 text-red-600' : 'bg-green-50 text-green-600'}`}>{u.active ? 'D√©sactiver' : 'Activer'}</button>
                </div>
              ))}
              {commercials.length === 0 && <EmptyState icon="Users" title="Aucun commercial" description="Ajoutez votre premier commercial" />}
            </div>
          </div>

          <Modal isOpen={showAdd} onClose={() => setShowAdd(false)} title="Ajouter un commercial" size="sm">
            <div className="space-y-4">
              <div><label className="block text-sm font-medium mb-2">Nom complet *</label><input type="text" value={newUser.name} onChange={(e) => setNewUser({ ...newUser, name: e.target.value })} className="input-field w-full px-4 py-3 rounded-xl" /></div>
              <div><label className="block text-sm font-medium mb-2">Email *</label><input type="email" value={newUser.email} onChange={(e) => setNewUser({ ...newUser, email: e.target.value })} className="input-field w-full px-4 py-3 rounded-xl" /></div>
              <div><label className="block text-sm font-medium mb-2">Mot de passe *</label><input type="text" value={newUser.password} onChange={(e) => setNewUser({ ...newUser, password: e.target.value })} className="input-field w-full px-4 py-3 rounded-xl" /></div>
              <div><label className="block text-sm font-medium mb-2">Lien Calendly</label><input type="url" value={newUser.calendly_link} onChange={(e) => setNewUser({ ...newUser, calendly_link: e.target.value })} className="input-field w-full px-4 py-3 rounded-xl" placeholder="https://calendly.com/..." /></div>
              <button onClick={handleAdd} disabled={saving} className="w-full btn-primary py-3 rounded-xl text-white font-semibold disabled:opacity-50">{saving ? 'Cr√©ation...' : 'Cr√©er le compte'}</button>
            </div>
          </Modal>
        </div>
      );
    };

    // ============================================
    // MAIN APP
    // ============================================
    const App = () => {
      const [user, setUser] = useState(null);
      const [currentView, setCurrentView] = useState('dashboard');
      const [prospects, setProspects] = useState([]);
      const [users, setUsers] = useState([]);
      const [templates, setTemplates] = useState(DEFAULT_TEMPLATES);
      const [leaderboard, setLeaderboard] = useState([]);
      const [toast, setToast] = useState(null);
      const [loading, setLoading] = useState(true);

      const showToast = useCallback((msg, type = 'success') => setToast({ message: msg, type }), []);

      useEffect(() => {
        const saved = localStorage.getItem('hormur_user');
        if (saved) try { setUser(JSON.parse(saved)); } catch { }
        setLoading(false);
      }, []);

      useEffect(() => {
        if (user && supabase) {
          loadData();
          const sub = supabase.channel('prospects-changes').on('postgres_changes', { event: '*', schema: 'public', table: 'prospects' }, loadProspects).subscribe();
          return () => sub.unsubscribe();
        }
      }, [user]);

      const loadData = async () => { await Promise.all([loadProspects(), loadUsers(), loadTemplates(), loadLeaderboard()]); };
      const loadProspects = async () => { const { data } = await supabase.from('prospects_with_assignee').select('*').order('last_update', { ascending: false }); setProspects(data || []); };
      const loadUsers = async () => { const { data } = await supabase.from('users').select('*').order('name'); setUsers(data || []); };
      const loadTemplates = async () => { const { data } = await supabase.from('message_templates').select('*').eq('is_active', true).order('sort_order'); if (data?.length) setTemplates(data); };
      const loadLeaderboard = async () => { const { data } = await supabase.from('leaderboard').select('*'); setLeaderboard(data || []); };

      const handleLogin = (u) => setUser(u);
      const handleLogout = () => { localStorage.removeItem('hormur_user'); setUser(null); };
      const updateUser = (u) => { setUser(u); localStorage.setItem('hormur_user', JSON.stringify(u)); };

      const claimLead = async (id) => {
        await supabase.from('prospects').update({ status: 'ASSIGNED', assigned_to: user.id, assigned_at: new Date().toISOString() }).eq('id', id);
        await supabase.from('activity_log').insert({ user_id: user.id, prospect_id: id, action: 'lead_claimed' });
        showToast('Lead assign√© !');
        loadProspects(); loadLeaderboard();
      };

      const updateProspectStatus = async (id, status) => {
        await supabase.from('prospects').update({ status, last_update: new Date().toISOString() }).eq('id', id);
        await supabase.from('activity_log').insert({ user_id: user.id, prospect_id: id, action: 'status_changed', details: { new_status: status } });
        showToast(`Statut : ${STATUSES[status]?.label || status}`);
        loadProspects(); loadLeaderboard();
      };

      const unreadCount = useMemo(() => prospects.filter(p => p.status === 'REPLIED' && !p.assigned_to).length, [prospects]);

      if (loading) return <div className="min-h-screen flex items-center justify-center"><Spinner size="lg" /></div>;
      if (!user) return <LoginPage onLogin={handleLogin} />;

      const contextValue = { user, users, templates, prospects, leaderboard, showToast, claimLead, updateProspectStatus, refreshProspects: loadProspects, refreshUsers: loadUsers, updateUser, setCurrentView };

      return (
        <AppContext.Provider value={contextValue}>
          <div className="min-h-screen pb-24 md:pb-8">
            <Navigation currentView={currentView} setCurrentView={setCurrentView} user={user} onLogout={handleLogout} unreadCount={unreadCount} />
            <main className="pt-20 md:pt-28 px-4 md:px-8 max-w-7xl mx-auto">
              {currentView === 'dashboard' && <DashboardView />}
              {currentView === 'pipeline' && <PipelineView />}
              {currentView === 'prospects' && <ProspectsView />}
              {currentView === 'leaderboard' && <LeaderboardView />}
              {currentView === 'profile' && <ProfileView />}
              {currentView === 'admin' && user.role === 'admin' && <AdminView />}
            </main>
            {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
          </div>
        </AppContext.Provider>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>

</html>